<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Deployment and Update &#8212; GGRC 0.10.35-Raspberry (5972f93) documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.10.35-Raspberry (5972f93)',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="GGRC 0.10.35-Raspberry (5972f93) documentation" href="../index.html" />
    <link rel="up" title="Support" href="index.html" />
    <link rel="next" title="Contribution Guidelines" href="../contributing/index.html" />
    <link rel="prev" title="Support" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../contributing/index.html" title="Contribution Guidelines"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Support"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">GGRC 0.10.35-Raspberry (5972f93) documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Support</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="deployment-and-update">
<h1>Deployment and Update<a class="headerlink" href="#deployment-and-update" title="Permalink to this headline">¶</a></h1>
<p>TODO (Please add any questions or clarification requests here):</p>
<ol class="arabic simple">
<li>Add a summary of deployment-specific values (e.g., filename of
deployment settings file, filename of <code class="docutils literal"><span class="pre">ggrc/settings/*</span></code> file)
and/or use some convention to denote these as variable in this
document</li>
<li>Add a CHANGELOG’ or version/upgrade matrix in steps 2 and 3 (and 5,
for settings modules) to make it clear when the step must be repeated
or more closely examined (or which values/APIs have changed)</li>
<li>Add note about how to verify backup in Cloud Storage</li>
<li>Update <code class="docutils literal"><span class="pre">deploy_appengine</span></code> to (optionally) handle migrations &#8211;
environment variables and database settings are too opaque and
error-prone. Could also have it check and warn about valid settings
in settings files, maybe? At least several “verify this value” steps
for database and App Engine instance name.</li>
<li>Add steps to set up a new Cloud SQL instance.</li>
</ol>
<div class="section" id="complete-initial-development-environment-setup">
<h2>0. Complete initial development environment setup<a class="headerlink" href="#complete-initial-development-environment-setup" title="Permalink to this headline">¶</a></h2>
<p>This step should only need to be done once per deployment machine.
Intall the requirements and clone the repo following instructions
in&nbsp;the main <a class="reference external" href="https://github.com/google/ggrc-core/blob/dev/README.md">README</a>.</p>
</div>
<div class="section" id="create-update-deployment-settings">
<h2>1. Create/Update deployment settings<a class="headerlink" href="#create-update-deployment-settings" title="Permalink to this headline">¶</a></h2>
<p>By convention, these files will be located in
<code class="docutils literal"><span class="pre">extras/deploy/&lt;something&gt;</span></code>, where <code class="docutils literal"><span class="pre">&lt;something&gt;</span></code> is the name of
the deployment instance. These files are not part of the repository,
as they are deployment-specific and contain private data (API keys,
for instance).</p>
<p>Create or update the deployment settings
(e.g. <code class="docutils literal"><span class="pre">extras/deploy/test-instance</span></code>). If this is an upgrade, this
file will likely be complete, except for a recent change to the set or
expected values of settings.</p>
<p>To create deployment settings for a new project, please do (assuming
you are in the project root directory):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">PROJECT</span><span class="o">=</span><span class="s2">&quot;test-instance&quot;</span>
mkdir -pv <span class="s2">&quot;./extras/deploy/</span><span class="nv">$PROJECT</span><span class="s2">&quot;</span>
cp <span class="s2">&quot;./extras/deploy/override-template.sh&quot;</span> <span class="s2">&quot;./extras/deploy/</span><span class="nv">$PROJECT</span><span class="s2">/override.sh&quot;</span>
cp <span class="s2">&quot;./extras/deploy/settings-template.sh&quot;</span> <span class="s2">&quot;./extras/deploy/</span><span class="nv">$PROJECT</span><span class="s2">/settings.sh&quot;</span>
</pre></div>
</div>
<div class="section" id="settings-from-settings-sh">
<h3>Settings from <code class="docutils literal"><span class="pre">settings.sh</span></code><a class="headerlink" href="#settings-from-settings-sh" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="28%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Setting</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>APPENGINE_INSTANCE</td>
<td>The “Application Identifier” you see at <a class="reference external" href="https://console.cloud.google.com/">Cloud console</a></td>
</tr>
<tr class="row-odd"><td>SETTINGS_MODULE</td>
<td>List of Python modules importable from <code class="docutils literal"><span class="pre">src</span></code> or <code class="docutils literal"><span class="pre">src/ggrc/settings</span></code>
that provide different parameters for the app</td>
</tr>
<tr class="row-even"><td>DATABASE_URI</td>
<td>The connection string for the database. Should be constructed using
DB_NAME, DB_INSTANCE_CONNECTION_NAME.</td>
</tr>
<tr class="row-odd"><td>DB_NAME</td>
<td>The name of the application&#8217;s database</td>
</tr>
<tr class="row-even"><td>DB_INSTANCE_CONNECTION_NAME</td>
<td>Connection string for your database instance</td>
</tr>
<tr class="row-odd"><td>GAPI_KEY</td>
<td>The “Browser Key” from Step 2</td>
</tr>
<tr class="row-even"><td>GAPI_CLIENT_ID</td>
<td>The “OAuth Client ID” from Step 2</td>
</tr>
<tr class="row-odd"><td>GAPI_CLIENT_SECRET</td>
<td>The “OAuth Client Secret” from Step 2</td>
</tr>
<tr class="row-even"><td>GAPI_ADMIN_GROUP</td>
<td>The group which is used in messages like &#8220;Contact your admin at
<code class="docutils literal"><span class="pre">&lt;group_email&gt;</span></code>&#8220;</td>
</tr>
<tr class="row-odd"><td>APPENGINE_EMAIL</td>
<td>The email address to use as the “From” address in outgoing email
notifications</td>
</tr>
<tr class="row-even"><td>INSTANCE_CLASS</td>
<td>The instance class that should be used on appengine</td>
</tr>
<tr class="row-odd"><td>MAX_INSTANCES</td>
<td>The maximum number of instances to be used on appengine</td>
</tr>
<tr class="row-even"><td>SECRET_KEY</td>
<td>Random string that is used as a seed for Flask session ids</td>
</tr>
<tr class="row-odd"><td>GOOGLE_ANALYTICS_ID</td>
<td>Project ID for Google Analytics</td>
</tr>
<tr class="row-even"><td>GOOGLE_ANALYTICS_DOMAIN</td>
<td>Project domain for Google Analytics</td>
</tr>
<tr class="row-odd"><td>BOOTSTRAP_ADMIN_USERS</td>
<td>Space-separated emails of users granted superuser access (usually the
people who deploy and manage the project)</td>
</tr>
<tr class="row-even"><td>MIGRATOR</td>
<td><strong>UNUSED</strong> Name and email of the user that is used as current user during
migrations</td>
</tr>
<tr class="row-odd"><td>RISK_ASSESSMENT_URL</td>
<td>Link to Risk Assessment application</td>
</tr>
<tr class="row-even"><td>CUSTOM_URL_ROOT</td>
<td>Equal to the URL where the app is supposed to be deployed too; used to
generate links to internal objects in email notifications</td>
</tr>
<tr class="row-odd"><td>ABOUT_URL</td>
<td>Link to the About document</td>
</tr>
<tr class="row-even"><td>ABOUT_TEXT</td>
<td>Text that is shown on the login page</td>
</tr>
<tr class="row-odd"><td>EXTERNAL_HELP_URL</td>
<td>Link to user documentation on an external service</td>
</tr>
<tr class="row-even"><td>EXTERNAL_IMPORT_HELP_URL</td>
<td>Link to import-specific user documentation on an external service</td>
</tr>
<tr class="row-odd"><td>GGRC_Q_INTEGRATION_URL</td>
<td>Link to GGRCQ instance synced with this instance</td>
</tr>
<tr class="row-even"><td>DASHBOARD_INTEGRATION</td>
<td>Link to Dashboards that use data from this instance</td>
</tr>
<tr class="row-odd"><td>ALLOWED_QUERYAPI_APP_IDS</td>
<td>List of Appengine application ids that are allowed to access this
instance&#8217;s APIs</td>
</tr>
<tr class="row-even"><td>AUTHORIZED_DOMAIN</td>
<td>Users from this domain automatically get Creator role</td>
</tr>
<tr class="row-odd"><td>SCALING</td>
<td><code class="docutils literal"><span class="pre">app.yaml:*scaling</span></code> section</td>
</tr>
<tr class="row-even"><td>STATIC_SERVING</td>
<td>Section of <code class="docutils literal"><span class="pre">app.yaml:handlers</span></code> to serve static files as static (doesn&#8217;t
work properly on some instances and not enabled by default)</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="settings-from-override-sh">
<h3>Settings from <code class="docutils literal"><span class="pre">override.sh</span></code><a class="headerlink" href="#settings-from-override-sh" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="82%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Setting</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>GGRC_DATABASE_URI</td>
<td>The connection string for the database (using connection by IP, as it is used by
the migrations runner that is launched from your host during deployment). Should be
constructed using DB_USER, DB_PASSWORN, DB_IP</td>
</tr>
<tr class="row-odd"><td>DB_USER</td>
<td>Username of the migrator in the DB</td>
</tr>
<tr class="row-even"><td>DB_PASSWORD</td>
<td>Password of the migrator in the DB</td>
</tr>
<tr class="row-odd"><td>DB_IP</td>
<td>IP address of the SQL instance</td>
</tr>
</tbody>
</table>
<p>There may also be a customized <code class="docutils literal"><span class="pre">src/ggrc/settings/&lt;something&gt;.py</span></code>
file, for example, <code class="docutils literal"><span class="pre">ggrc/settings/app_engine_test_instance.py</span></code> (This
file should also not be included in the repository, though examples
can be found at <a class="reference external" href="https://github.com/google/ggrc-core/tree/dev/src/ggrc/settings">src/ggrc/settings</a>). This file can contain
additional configuration variables, including:</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Setting</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>COMPANY</td>
<td>This is the company name shown in the “Copyright” footer at
the bottom of each page</td>
</tr>
<tr class="row-odd"><td>COMPANY_LOGO</td>
<td>If specified, this is an image to be displayed in the top-left corner
of each page.</td>
</tr>
<tr class="row-even"><td>COMPANY_LOGO_TEXT</td>
<td>If COMPANY_LOGO is not set, this (text) value is used instead of an image in
the top-left corner of each page.</td>
</tr>
<tr class="row-odd"><td>SQLALCHEMY_RECORD_QUERIES</td>
<td>This setting causes queries to be reported in the App Engine logs. Possible
options are: &#8216;count&#8217; - only the number of queries is logged, &#8216;slow&#8217; - only slow
queries are logged, &#8216;all&#8217; - all queries are logged.  This is useful for
debugging purposes.</td>
</tr>
<tr class="row-even"><td>CALENDAR_MECHANISM</td>
<td>If True, Workflow includes Google Calendar integration</td>
</tr>
</tbody>
</table>
<p>Please note: settings files must use ASCII quotation marks, not the
stylized marks used in rich text documents. E.g., they should be
straight, like &#8221; or &#8216;, not “” or ‘’.</p>
</div>
</div>
<div class="section" id="configure-google-apis">
<h2>2. Configure Google APIs<a class="headerlink" href="#configure-google-apis" title="Permalink to this headline">¶</a></h2>
<p>Note: This step only needs to be done once, but required APIs might
change, so during upgrades, verify rather than add the APIs and keys.</p>
<ol class="arabic">
<li><p class="first">Go to the <a class="reference external" href="https://console.cloud.google.com/">Cloud Console</a> and select the Project being updated.</p>
</li>
<li><p class="first">Click “APIs &amp; services” in the left-hand column. Find each of the
following APIs and enable it:</p>
<ul class="simple">
<li>Drive API</li>
<li>Google Picker API</li>
</ul>
<p>Your screen should now look like the following:</p>
<div class="figure">
<img alt="Enable APIs" src="../_images/deployment1.png" />
</div>
</li>
<li><p class="first">Select “Credentials” in the left-hand column, and click “Create
credentials” → “OAuth client ID”.</p>
<ul>
<li><p class="first">Select “Web Application”</p>
</li>
<li><p class="first">Add “<a class="reference external" href="https:/">https:/</a>/&lt;your-project&gt;.appspot.com” to the box labeled
“Authorized JavaScript origins”</p>
</li>
<li><p class="first">Add “<a class="reference external" href="https:/">https:/</a>/&lt;your-project&gt;.appspot.com/authorize” to the box
labeled “Authorized redirect URI”</p>
<p>Your screen should look like the following:</p>
<div class="figure">
<img alt="Create Client ID" src="../_images/deployment2.png" />
</div>
</li>
<li><p class="first">Click “Create Client ID”. You&#8217;ll see a popup with new Client ID
and Client Secret that should be stored into your
<code class="docutils literal"><span class="pre">settings.sh</span></code> <code class="docutils literal"><span class="pre">GAPI_CLIENT_ID</span></code> and <code class="docutils literal"><span class="pre">GAPI_CLIENT_SECRET</span></code>
respectively.</p>
<p><strong>Please note!</strong></p>
<p>The “Client Secret” should never be revealed to untrusted
parties. If other parties have the “Client secret” value, they
may be able to impersonate the GGRC application.</p>
</li>
</ul>
</li>
<li><p class="first">Click “Create credentials” → “API key”. You&#8217;ll see a popup with a
new API key that you should store into <code class="docutils literal"><span class="pre">settings.sh</span></code>
<code class="docutils literal"><span class="pre">GAPI_KEY</span></code>.</p>
</li>
</ol>
<p>Now we’re done setting up the Google APIs and ready for the deployment.</p>
</div>
<div class="section" id="backup-the-database-via-google-cloud-console">
<h2>3. Backup the database via Google Cloud Console<a class="headerlink" href="#backup-the-database-via-google-cloud-console" title="Permalink to this headline">¶</a></h2>
<p>In the left-hand column of the <a class="reference external" href="https://console.cloud.google.com/">Cloud Console</a>, select “Cloud SQL”
and select the database instance to be used.</p>
<p>In the top line, click the “Export...” button, select a Cloud Storage
path, and click “OK”. The Cloud Storage Path should look something like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">gs</span><span class="p">:</span><span class="o">//****-</span><span class="n">backups</span><span class="o">/****-</span><span class="n">yyyymmdd</span><span class="o">.</span><span class="n">sql</span>
</pre></div>
</div>
</div>
<div class="section" id="complete-the-deployment">
<h2>4. Complete the deployment<a class="headerlink" href="#complete-the-deployment" title="Permalink to this headline">¶</a></h2>
<p>Go back to your local environment and do the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./bin/deploy test-instance
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">test-instance</span></code> is the name of the directory that contains your
settings.</p>
<p>The script creates a container, installs all the dependencies inside,
runs the migrations and deploys the application.</p>
<p>To deploy a specific version, run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./bin/deploy test-instance <span class="m">0</span>.10.35-Raspberry  <span class="c1"># a tag or a branch name</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Deployment and Update</a><ul>
<li><a class="reference internal" href="#complete-initial-development-environment-setup">0. Complete initial development environment setup</a></li>
<li><a class="reference internal" href="#create-update-deployment-settings">1. Create/Update deployment settings</a><ul>
<li><a class="reference internal" href="#settings-from-settings-sh">Settings from <code class="docutils literal"><span class="pre">settings.sh</span></code></a></li>
<li><a class="reference internal" href="#settings-from-override-sh">Settings from <code class="docutils literal"><span class="pre">override.sh</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#configure-google-apis">2. Configure Google APIs</a></li>
<li><a class="reference internal" href="#backup-the-database-via-google-cloud-console">3. Backup the database via Google Cloud Console</a></li>
<li><a class="reference internal" href="#complete-the-deployment">4. Complete the deployment</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Support</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../contributing/index.html"
                        title="next chapter">Contribution Guidelines</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/support/deployment_and_update.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../contributing/index.html" title="Contribution Guidelines"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Support"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">GGRC 0.10.35-Raspberry (5972f93) documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Support</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Google Inc..
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.6.
    </div>
  </body>
</html>