#!/usr/bin/env bash
# Copyright (C) 2017 Google Inc.
# Licensed under http://www.apache.org/licenses/LICENSE-2.0 <see LICENSE file>

TEST_DB_NAME="ggrcdevtest_apisearch"
SCRIPTPATH=$( cd "$(dirname "$0")" ; pwd -P )
HOST=${GGRC_DATABASE_HOST-"127.0.0.1"}
DB_NAME="ggrcdevtest_apisearch"
DUMP_FILE="api_search.sql"
DUMP_PATH_NAME="${SCRIPTPATH}/../test/api_search/db_dump/${DUMP_FILE}"
cd "${SCRIPTPATH}/../test"
find . -iname "*.pyc" -delete

export GGRC_SETTINGS_MODULE="testing \
  testing_api_search_db \
  ggrc_basic_permissions.settings.development \
  ggrc_risk_assessments.settings.development \
  ggrc_risks.settings.development \
  ggrc_workflows.settings.development \
  ggrc_gdrive_integration.settings.development"

mysql -uroot -proot -h$HOST -e "DROP DATABASE IF EXISTS ${DB_NAME}; CREATE DATABASE ${DB_NAME} CHARACTER SET utf8; USE ${DB_NAME};"
db_migrate

echo "Fill database with test setup data"
python -c "\
from api_search.setup_environment import SetupEnvironment
SetupEnvironment()
"

mysqldump -uroot -proot -h$HOST $TEST_DB_NAME > $DUMP_PATH_NAME
