<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Automapping &#8212; GGRC 0.10.35-Raspberry (f8c1d69) documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.10.35-Raspberry (f8c1d69)',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="GGRC 0.10.35-Raspberry (f8c1d69) documentation" href="../index.html" />
    <link rel="up" title="Backend" href="index.html" />
    <link rel="next" title="Extensions" href="extensions.html" />
    <link rel="prev" title="Object Manipulation" href="object_manipulation.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="extensions.html" title="Extensions"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="object_manipulation.html" title="Object Manipulation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">GGRC 0.10.35-Raspberry (f8c1d69) documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Backend</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="automapping">
<h1>Automapping<a class="headerlink" href="#automapping" title="Permalink to this headline">¶</a></h1>
<p>This is a process that automatically creates mappings based on user
created mappings (basically, automappings can be seen as transitivity
rules for mappings).</p>
<div class="section" id="ggrc-automapper">
<h2><code class="docutils literal"><span class="pre">ggrc.automapper</span></code><a class="headerlink" href="#ggrc-automapper" title="Permalink to this headline">¶</a></h2>
<p>This defines the entry point <code class="docutils literal"><span class="pre">register_automapping_listeners</span></code> that
registers an event listener that fires on every user-created mapping.
Based on the neighborhood of the two mapped objects it fires the
appropriate rules and creates new mappings. The process is then repeated
for newly created mappings. This effectively traverses the local
relevant subgraph as defined by the rules.</p>
</div>
<div class="section" id="ggrc-automapper-rules">
<h2><code class="docutils literal"><span class="pre">ggrc.automapper.rules</span></code><a class="headerlink" href="#ggrc-automapper-rules" title="Permalink to this headline">¶</a></h2>
<p>This defines rules for mapping creation as data. This approach allows
for automatic sanity checking of the rules which can help prevent
unintended blowups of the auto-mappings. In order to keep automatic
mappings under control we impose a tree structure on the mappings graph
as defined by <code class="docutils literal"><span class="pre">type_ordering</span></code>. Then we only allow auto-mappings
between <code class="docutils literal"><span class="pre">A</span></code> and <code class="docutils literal"><span class="pre">C</span></code> if the <code class="docutils literal"><span class="pre">ABC</span></code> path is a minor of the mappings
tree.</p>
</div>
<div class="section" id="automapping-example">
<h2>Automapping example<a class="headerlink" href="#automapping-example" title="Permalink to this headline">¶</a></h2>
<p>Automapping rules are defined by a namedtuple <code class="docutils literal"><span class="pre">Rule(top,</span> <span class="pre">mid,</span>
<span class="pre">bottom)</span></code> where top, mid, bottom are sets of types.</p>
<p>For example, we have the following two rules set:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">Rule</span><span class="p">({</span><span class="s2">&quot;Program&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;Regulation&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;Section&quot;</span><span class="p">,</span> <span class="s2">&quot;Objective&quot;</span><span class="p">})</span>
<span class="n">Rule</span><span class="p">({</span><span class="s2">&quot;Regulation&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;Section&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;Objective&quot;</span><span class="p">})</span>
</pre></div>
</div>
<p>These rules are &#8220;exploded&#8221; and transformed into the following tuples
(concatenated cross products of sets in each rule):</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s2">&quot;Program&quot;</span><span class="p">,</span> <span class="s2">&quot;Regulation&quot;</span><span class="p">,</span> <span class="s2">&quot;Objective&quot;</span><span class="p">),</span>
<span class="p">(</span><span class="s2">&quot;Program&quot;</span><span class="p">,</span> <span class="s2">&quot;Regulation&quot;</span><span class="p">,</span> <span class="s2">&quot;Section&quot;</span><span class="p">),</span>
<span class="p">(</span><span class="s2">&quot;Regulation&quot;</span><span class="p">,</span> <span class="s2">&quot;Section&quot;</span><span class="p">,</span> <span class="s2">&quot;Objective&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Since mappings are non-directional, each tuple is reversed and added
to the list:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s2">&quot;Program&quot;</span><span class="p">,</span> <span class="s2">&quot;Regulation&quot;</span><span class="p">,</span> <span class="s2">&quot;Section&quot;</span><span class="p">),</span>
<span class="p">(</span><span class="s2">&quot;Program&quot;</span><span class="p">,</span> <span class="s2">&quot;Regulation&quot;</span><span class="p">,</span> <span class="s2">&quot;Objective&quot;</span><span class="p">),</span>
<span class="p">(</span><span class="s2">&quot;Regulation&quot;</span><span class="p">,</span> <span class="s2">&quot;Section&quot;</span><span class="p">,</span> <span class="s2">&quot;Objective&quot;</span><span class="p">),</span>
<span class="p">(</span><span class="s2">&quot;Section&quot;</span><span class="p">,</span> <span class="s2">&quot;Regulation&quot;</span><span class="p">,</span> <span class="s2">&quot;Program&quot;</span><span class="p">),</span>
<span class="p">(</span><span class="s2">&quot;Objective&quot;</span><span class="p">,</span> <span class="s2">&quot;Regulation&quot;</span><span class="p">,</span> <span class="s2">&quot;Program&quot;</span><span class="p">),</span>
<span class="p">(</span><span class="s2">&quot;Objective&quot;</span><span class="p">,</span> <span class="s2">&quot;Section&quot;</span><span class="p">,</span> <span class="s2">&quot;Regulation&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Each time a mapping between O1 and O2 of types T1 and T2 is created,
the app performs the following:</p>
<blockquote>
<div><ul class="simple">
<li>Find each rule where (T1, T2) is the first two items of the rule;
suppose T3 is the third item of the rule.</li>
<li>For each object of type T3 that is mapped to O2, create a mapping
between that object and O1.</li>
<li>Do the same two steps in the opposite direction (O2, O1).</li>
</ul>
</div></blockquote>
<p>Each mapping created during this procedure triggers automappings too.</p>
<p>Let&#8217;s check a more concrete example.</p>
<p>There is a Regulation mapped to a Section:</p>
<img src="../_images/graphviz-bafbcf7417ac3ff8bc2927c3ad12d34f44308466.png" alt="Regulation mapped to Section" />
<p>The user creates Objective A and maps it to Section A.</p>
<ol class="arabic simple">
<li>The app searches rules by (&#8220;Section&#8221;, &#8220;Objective&#8221;) key and finds
none.</li>
<li>The app searches rules by (&#8220;Objective&#8221;, &#8220;Section&#8221;) key and finds
(&#8220;Objective&#8221;, &#8220;Section&#8221;, &#8220;Regulation&#8221;) rule.<ol class="arabic">
<li>The app finds Regulation A mapped to Section A and maps it to
Objective A.<ol class="arabic">
<li>The app searches rules by (&#8220;Regulation&#8221;, &#8220;Objective&#8221;) key and finds
none.</li>
<li>The app searches rules by (&#8220;Objective&#8221;, &#8220;Regulation&#8221;) key and finds
(&#8220;Objective&#8221;, &#8220;Regulation&#8221;, &#8220;Program&#8221;).<ol class="arabic">
<li>The app finds no Programs mapped to Regulation A.</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<img src="../_images/graphviz-9b07e43cefb340017e963b7ec97f30a44184fd7a.png" alt="New Objective mapped to Section and automapped to Regulation" />
<p>Then the user creates Program A and maps it to Regulation A.</p>
<ol class="arabic simple">
<li>The app searches rules by (&#8220;Program&#8221;, &#8220;Regulation&#8221;) key and finds
(&#8220;Program&#8221;, &#8220;Regulation&#8221;, Section&#8221;) and (&#8220;Program&#8221;, &#8220;Regulation&#8221;,
&#8220;Objective&#8221;).<ol class="arabic">
<li>The app finds Section A mapped to Regulation A and maps it to
Program A.<ol class="arabic">
<li>The app searches rules by (&#8220;Section&#8221;, &#8220;Program&#8221;) key and
finds none.</li>
<li>The app searches rules by (&#8220;Program&#8221;, &#8220;Section&#8221;) key and
finds none.</li>
</ol>
</li>
<li>The app finds Objective A mapped to Regulation A and maps it to
Program A.<ol class="arabic">
<li>The app searches rules by (&#8220;Objective&#8221;, &#8220;Program&#8221;) key and
finds none.</li>
<li>The app searches rules by (&#8220;Program&#8221;, &#8220;Objective&#8221;) key and
finds none.</li>
</ol>
</li>
</ol>
</li>
<li>The app searches rules by (&#8220;Regulation&#8221;, &#8220;Program&#8221;) key and finds
none.</li>
</ol>
<img src="../_images/graphviz-bbfb84fda48cedb26359fbe7d7b7c1a4e923b5b4.png" alt="New Program mapped to Regulation and automapped to Objective" />
<p>Now the user creates Objective B and maps it to Section A.</p>
<ol class="arabic simple">
<li>The app searches rules by (&#8220;Objective&#8221;, &#8220;Section&#8221;) key and finds
(&#8220;Objective&#8221;, &#8220;Section&#8221;, &#8220;Regulation&#8221;).<ol class="arabic">
<li>The app finds Regulation A mapped to Section A and maps it to
Objective B.<ol class="arabic">
<li>The app searches rules by (&#8220;Regulation&#8221;, &#8220;Objective&#8221;) key and
finds none.</li>
<li>The app searches rules by (&#8220;Objective&#8221;, &#8220;Regulation&#8221;) key and
finds (&#8220;Objective&#8221;, &#8220;Regulation&#8221;, &#8220;Program&#8221;).<ol class="arabic">
<li>The app finds Program A mapped to Regulation A and maps it
to Objective B.<ol class="arabic">
<li>The app searches rules by (&#8220;Program&#8221;, &#8220;Objective&#8221;) key
and finds none.</li>
<li>The app searches rules by (&#8220;Objective&#8221;, &#8220;Program&#8221;) key
and finds none.</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>The app searches rules by (&#8220;Section&#8221;, &#8220;Objective&#8221;) key and finds
none.</li>
</ol>
<img src="../_images/graphviz-d2cb52bc24f281fa2adceb37f65e09cf3f0b9e17.png" alt="New Objective mapped to Section and automapped to Regulation
and Program" />
<p>The process is iterative, and the set of rules can be much more complex.</p>
</div>
<div class="section" id="implementation-details">
<h2>Implementation details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h2>
<p>The list of rules is transformed into a dict of rules by code like:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">rules</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="k">for</span> <span class="n">from</span><span class="p">,</span> <span class="n">to_</span><span class="p">,</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
    <span class="n">rules</span><span class="p">[(</span><span class="n">from</span><span class="p">,</span> <span class="n">to_</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span>

<span class="c1"># {(&quot;Program&quot;, &quot;Regulation&quot;): [&quot;Section&quot;, &quot;Objective&quot;],</span>
<span class="c1">#  (&quot;Regulation&quot;, &quot;Section&quot;): [&quot;Objective&quot;],</span>
<span class="c1">#  (&quot;Section&quot;, &quot;Regulation&quot;): [&quot;Program&quot;],</span>
<span class="c1">#  (&quot;Objective&quot;, &quot;Regulation&quot;): [&quot;Program&quot;],</span>
<span class="c1">#  (&quot;Objective&quot;, &quot;Section&quot;): [&quot;Regulation&quot;]}</span>
</pre></div>
</div>
<p>The dict makes each check for automapping rules <code class="docutils literal"><span class="pre">O(1)</span></code>.</p>
<p>To lower the memory footprint, each object is represented with a
minimal <code class="docutils literal"><span class="pre">namedtuple(&quot;Stub&quot;,</span> <span class="pre">[&quot;type&quot;,</span> <span class="pre">&quot;id&quot;])</span></code>, which is hashable and
sortable (can be stored in sets, can be reliable ordered together with
another stub). Each mapping is represented with a tuple
<code class="docutils literal"><span class="pre">tuple(sorted([src_stub,</span> <span class="pre">dst_stub]))</span></code> internally, which is hashable
as well.</p>
<p>To minimize the number of DB queries, we support a local cache that
stores what objects are mapped to an instance: <code class="docutils literal"><span class="pre">{src_stub:</span>
<span class="pre">{dst_stubs}}</span></code>. The cache is populated with all objects for which we
search mapped objects, and it is updated each time we perform an
automapping.</p>
<p>To linearize the automappings generation and keep the call stack
shallow, instead of recursive calls to automapping calculation
function we store each new mapping that should be processed to a set
<code class="docutils literal"><span class="pre">self.queue</span></code>, and <code class="docutils literal"><span class="pre">pop</span></code> this set in a loop. To avoid duplicate
processing for each mapping, we store a set of processed mappings in a
set <code class="docutils literal"><span class="pre">self.processed</span></code>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Automapping</a><ul>
<li><a class="reference internal" href="#ggrc-automapper"><code class="docutils literal"><span class="pre">ggrc.automapper</span></code></a></li>
<li><a class="reference internal" href="#ggrc-automapper-rules"><code class="docutils literal"><span class="pre">ggrc.automapper.rules</span></code></a></li>
<li><a class="reference internal" href="#automapping-example">Automapping example</a></li>
<li><a class="reference internal" href="#implementation-details">Implementation details</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="object_manipulation.html"
                        title="previous chapter">Object Manipulation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="extensions.html"
                        title="next chapter">Extensions</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/backend/automapping.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="extensions.html" title="Extensions"
             >next</a> |</li>
        <li class="right" >
          <a href="object_manipulation.html" title="Object Manipulation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">GGRC 0.10.35-Raspberry (f8c1d69) documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Backend</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Google Inc..
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.6.
    </div>
  </body>
</html>